<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Import Tool (Auto-Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 p-10 font-sans">

    <div class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“¦ Produkte Importieren (Ø¨Ø§ ØªØ¹Ù…ÛŒØ± Ø®ÙˆØ¯Ú©Ø§Ø±)</h1>
        <p class="text-sm text-gray-500 mb-4">Ø§ÛŒÙ† Ø³ÛŒØ³ØªÙ… Ú©Ø¯Ù‡Ø§ÛŒ Ú†Ø³Ø¨ÛŒØ¯Ù‡ Ø¨Ù‡ Ø§Ø³Ù… Ø±Ø§ Ø¨Ù‡ Ø·ÙˆØ± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¬Ø¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</p>
        
        <div class="mb-6 p-8 border-2 border-dashed border-green-300 rounded-lg bg-green-50 text-center cursor-pointer hover:bg-green-100 transition" onclick="document.getElementById('fileInput').click()">
            <span class="text-4xl">ğŸ› ï¸</span>
            <p class="mt-2 font-bold text-green-700">ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleFileSelect()">
        </div>

        <button id="uploadBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded shadow-md disabled:opacity-50 transition" onclick="processFile()" disabled>
            Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ ØªØ¹Ù…ÛŒØ±
        </button>

        <div class="mt-6">
            <div id="status" class="font-bold text-gray-600 mb-2">Ù…Ù†ØªØ¸Ø± ÙØ§ÛŒÙ„...</div>
            <div id="logArea" class="w-full h-80 p-4 border rounded bg-gray-900 text-green-400 font-mono text-xs overflow-y-auto" dir="ltr"></div>
        </div>
    </div>

    <script type="module">
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø´Ù…Ø§ (Ø§Ø² Ú©Ø¯ÛŒ Ú©Ù‡ ÙØ±Ø³ØªØ§Ø¯ÛŒØ¯ Ø¨Ø±Ø¯Ø§Ø´ØªÙ…)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCY9TmJwzoJRWFTAjhDFBD0eFMR4YKTHJQ",
            authDomain: "listapp-96713.firebaseapp.com",
            projectId: "listapp-96713",
            storageBucket: "listapp-96713.firebasestorage.app",
            messagingSenderId: "1044312662356",
            appId: "1:1044312662356:web:64fd48530c4238127828c1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
        function log(msg, color="text-green-400") {
            const area = document.getElementById('logArea');
            area.innerHTML += `<div class="${color} border-b border-gray-800 py-1">> ${msg}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        window.handleFileSelect = function() {
            const input = document.getElementById('fileInput');
            const btn = document.getElementById('uploadBtn');
            if (input.files.length > 0) {
                btn.disabled = false;
                document.getElementById('status').innerText = "âœ… ÙØ§ÛŒÙ„ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª: " + input.files[0].name;
            }
        }

        window.processFile = async function() {
            const fileInput = document.getElementById('fileInput');
            const btn = document.getElementById('uploadBtn');
            
            btn.disabled = true;
            btn.innerText = "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...";
            
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName]);

                    log(`ÙØ§ÛŒÙ„ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯. ${jsonData.length} Ø±Ø¯ÛŒÙ Ù¾ÛŒØ¯Ø§ Ø´Ø¯.`);

                    let batch = writeBatch(db);
                    let count = 0;
                    let successCount = 0;

                    for (const row of jsonData) {
                        // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù…
                        let code = String(row['Produktcode'] || row['Code'] || '').trim();
                        let name = String(row['Produktname'] || row['Name'] || row['Beschreibung'] || '').trim();
                        let category = row['Hauptgruppe'] || 'General';
                        let unit = row['Einheit'] || 'Stk';
                        let price = Number(row['Verkaufspreis']) || 0;

                        // ğŸ”´ Ø¨Ø®Ø´ ØªØ¹Ù…ÛŒØ± Ø®ÙˆØ¯Ú©Ø§Ø± (Auto-Fix Logic) ğŸ”´
                        // Ø§Ú¯Ø± Ú©Ø¯ Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ ÙˆÙ„ÛŒ Ø§Ø³Ù… Ø´Ø¨ÛŒÙ‡ "001 / Name" Ø¨ÙˆØ¯
                        if ((!code || code === "undefined") && name.includes('/')) {
                            const parts = name.split('/'); // Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ø§ Ø¹Ù„Ø§Ù…Øª Ø§Ø³Ù„Ø´
                            if (parts.length > 1) {
                                // ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¨Ø®Ø´ Ø§ÙˆÙ„ Ú©Ø¯ Ø§Ø³Øª Ùˆ Ø¨Ø®Ø´ Ø¯ÙˆÙ… Ø§Ø³Ù…
                                const potentialCode = parts[0].trim();
                                // Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¨Ø®Ø´ Ø§ÙˆÙ„ Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯ ÛŒØ§ Ú©ÙˆØªØ§Ù‡ Ø¨Ø§Ø´Ø¯
                                if (potentialCode.length < 10) { 
                                    code = potentialCode;
                                    name = parts.slice(1).join('/').trim(); // Ø¨Ù‚ÛŒÙ‡ Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ø§Ø³Ù…
                                    log(`ğŸ›  ØªØ¹Ù…ÛŒØ± Ø´Ø¯: [${code}] - ${name}`, "text-yellow-300");
                                }
                            }
                        }

                        // Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ù‡Ù… Ú©Ø¯ÛŒ Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø§ÛŒÙ† Ø±Ø¯ÛŒÙ Ø¨Ù‡ Ø¯Ø±Ø¯ Ù†Ù…ÛŒâ€ŒØ®ÙˆØ±Ø¯
                        if (!code || code === "undefined") {
                            // log(`Ø±Ø¯ Ø´Ø¯ (Ø¨Ø¯ÙˆÙ† Ú©Ø¯): ${name}`, "text-red-500");
                            continue;
                        }

                        // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡
                        const productData = {
                            code: code,
                            name: name,
                            category: category,
                            unit: unit,
                            price: price,
                            updatedAt: new Date()
                        };

                        const docRef = doc(db, "products", code);
                        batch.set(docRef, productData);

                        count++;
                        successCount++;

                        if (count >= 400) {
                            await batch.commit();
                            batch = writeBatch(db);
                            count = 0;
                            log(`--- Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (${successCount})... ---`, "text-blue-300");
                        }
                    }

                    if (count > 0) await batch.commit();

                    document.getElementById('status').innerText = `ğŸ‰ ØªÙ…Ø§Ù… Ø´Ø¯! ${successCount} Ù…Ø­ØµÙˆÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`;
                    document.getElementById('status').className = "font-bold text-green-600 mb-2";
                    log(`âœ… Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯.`, "text-green-400 font-bold text-lg");
                    alert(`Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²! \nØªØ¹Ø¯Ø§Ø¯ ${successCount} Ù…Ø­ØµÙˆÙ„ ÙˆØ§Ø±Ø¯ Ø³ÛŒØ³ØªÙ… Ø´Ø¯.`);

                } catch (error) {
                    console.error(error);
                    log(`ERROR: ${error.message}`, "text-red-500");
                    alert("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„");
                    btn.disabled = false;
                }
            };
            reader.readAsArrayBuffer(file);
        };
    </script>
</body>
</html>
