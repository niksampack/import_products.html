<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produkte Import (Bexio -> App)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 p-10 font-sans">

    <div class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-gray-800">üì¶ Produkte Importieren (Lager System)</h1>
        <p class="text-gray-600 mb-6">Laden Sie hier die Excel-Exportdatei Ihrer Produkte aus Bexio hoch.</p>
        
        <div class="mb-6 p-8 border-2 border-dashed border-blue-300 rounded-lg bg-blue-50 text-center cursor-pointer hover:bg-blue-100 transition" onclick="document.getElementById('fileInput').click()">
            <span class="text-4xl">üìÇ</span>
            <p class="mt-2 font-bold text-blue-700">Hier klicken & Excel-Datei w√§hlen</p>
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleFileSelect()">
        </div>

        <button id="uploadBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition" onclick="processFile()" disabled>
            Start Import
        </button>

        <div class="mt-6">
            <label class="font-bold text-sm text-gray-700">Status:</label>
            <div id="status" class="font-bold text-blue-600 mb-2">Warte auf Datei...</div>
            <div id="logArea" class="w-full h-64 p-4 border rounded bg-gray-900 text-green-400 font-mono text-xs overflow-y-auto shadow-inner"></div>
        </div>
    </div>

    <script type="module">
        // --------------------------------------------------------------
        // üîê CONFIG (ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ¥ÿØŸá ÿßÿ≤ ⁄©ÿØ ÿßÿ±ÿ≥ÿßŸÑ€å ÿ¥ŸÖÿß)
        // --------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCY9TmJwzoJRWFTAjhDFBD0eFMR4YKTHJQ",
            authDomain: "listapp-96713.firebaseapp.com",
            projectId: "listapp-96713",
            storageBucket: "listapp-96713.firebasestorage.app",
            messagingSenderId: "1044312662356",
            appId: "1:1044312662356:web:64fd48530c4238127828c1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --------------------------------------------------------------
        // ‚öôÔ∏è LOGIC
        // --------------------------------------------------------------
        
        window.handleFileSelect = function() {
            const input = document.getElementById('fileInput');
            const btn = document.getElementById('uploadBtn');
            const status = document.getElementById('status');
            
            if (input.files.length > 0) {
                btn.disabled = false;
                status.innerText = `‚úÖ Datei ausgew√§hlt: ${input.files[0].name}`;
            }
        }

        function log(msg, type="info") {
            const area = document.getElementById('logArea');
            const color = type === "error" ? "text-red-400" : (type === "success" ? "text-green-400" : "text-gray-300");
            area.innerHTML += `<div class="${color} border-b border-gray-800 py-1">> ${msg}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        window.processFile = async function() {
            const fileInput = document.getElementById('fileInput');
            const btn = document.getElementById('uploadBtn');
            const status = document.getElementById('status');

            if (!fileInput.files.length) return;

            btn.disabled = true;
            btn.innerText = "‚è≥ Wird verarbeitet...";
            status.innerText = "Lese Excel-Daten...";
            log("Starte Verarbeitung...", "info");

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // ÿØÿßÿØŸá‚ÄåŸáÿß ŸÖÿπŸÖŸàŸÑÿßŸã ÿØÿ± ÿ¥€åÿ™ ÿßŸàŸÑ Ÿáÿ≥ÿ™ŸÜÿØ
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        throw new Error("Datei ist leer oder hat falsches Format.");
                    }

                    log(`${jsonData.length} Produkte gefunden. Starte Upload...`, "info");

                    // ÿ¥ÿ±Ÿàÿπ ÿ®⁄Ü (Batch Write)
                    let batch = writeBatch(db);
                    let batchCount = 0;
                    let successCount = 0;

                    for (const row of jsonData) {
                        // üîç ŸÜ⁄Øÿßÿ¥ÿ™ ÿ≥ÿ™ŸàŸÜ‚ÄåŸáÿß€å Bexio
                        // ŸÖÿß ÿØŸÜÿ®ÿßŸÑ 'Produktcode' Ÿáÿ≥ÿ™€åŸÖ.
                        const code = String(row['Produktcode'] || row['Code'] || row['Artikelnummer'] || '').trim();
                        
                        if (!code) continue; // ÿß⁄Øÿ± ⁄©ÿØ ŸÜÿØÿßÿ¥ÿ™ ÿ±ÿØ ÿ¥Ÿà

                        const productData = {
                            code: code,
                            name: row['Produktname'] || row['Bezeichnung'] || row['Artikelname'] || 'Unbekannt',
                            // ‚ùÑÔ∏è ÿß€åŸÜ ÿÆÿ∑ ŸÖŸáŸÖÿ™ÿ±€åŸÜ ÿ®ÿÆÿ¥ ÿ®ÿ±ÿß€å ÿßŸÜÿ®ÿßÿ± ŸáŸàÿ¥ŸÖŸÜÿØ ÿßÿ≥ÿ™:
                            category: row['Hauptgruppe'] || 'General', 
                            subcategory: row['Untergruppe'] || '',
                            unit: row['Einheit'] || 'Stk',
                            price: Number(row['Verkaufspreis']) || 0,
                            updatedAt: new Date()
                        };

                        // ÿ∞ÿÆ€åÿ±Ÿá ÿØÿ± ⁄©ÿßŸÑ⁄©ÿ¥ŸÜ "products" (ŸÜŸá bexio_contacts)
                        const docRef = doc(db, "products", code);
                        batch.set(docRef, productData);

                        batchCount++;
                        successCount++;
                        log(`Hinzugef√ºgt: ${productData.name} (${productData.category})`);

                        // ŸÖÿ≠ÿØŸàÿØ€åÿ™ €µ€∞€∞ ÿ™ÿß€å€å ŸÅÿß€åÿ±ÿ®€åÿ≥
                        if (batchCount >= 400) {
                            await batch.commit();
                            batch = writeBatch(db);
                            batchCount = 0;
                            log(`--- Zwichenspeicherung (${successCount}...) ---`, "success");
                        }
                    }

                    // ÿ∞ÿÆ€åÿ±Ÿá ÿ®ÿßŸÇ€åŸÖÿßŸÜÿØŸá‚ÄåŸáÿß
                    if (batchCount > 0) {
                        await batch.commit();
                    }

                    status.innerText = "‚úÖ Import Erfolgreich!";
                    status.classList.add("text-green-600");
                    btn.innerText = "Fertig!";
                    btn.classList.add("bg-green-800");
                    
                    log("====================================", "success");
                    log(`üéâ FERTIG! ${successCount} Produkte wurden importiert.`, "success");
                    log("Sie k√∂nnen diese Seite jetzt schlie√üen.", "success");
                    alert(`Erfolg! ${successCount} Produkte importiert.`);

                } catch (error) {
                    console.error(error);
                    status.innerText = "‚ùå Fehler beim Import";
                    status.classList.add("text-red-600");
                    log(`FEHLER: ${error.message}`, "error");
                    btn.disabled = false;
                    btn.innerText = "Erneut versuchen";
                }
            };

            reader.readAsArrayBuffer(file);
        };
    </script>
</body>
</html>